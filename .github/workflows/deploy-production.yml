name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # ======================================
  # Job 1: Build and Test
  # ======================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: textisur_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript checks
        run: npm run typecheck

      - name: Run linting
        run: npm run lint

      - name: Run database migrations
        env:
          DATABASE_URL: mysql://root:test_password@localhost:3306/textisur_test
        run: node run-migration-manual.js

      - name: Build application
        env:
          NODE_ENV: production
          DATABASE_URL: mysql://root:test_password@localhost:3306/textisur_test
          JWT_SECRET: test_secret_for_ci
          STRIPE_SECRET_KEY: sk_test_mock
          NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: pk_test_mock
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next
            public
          retention-days: 1

  # ======================================
  # Job 2: Deploy to Production
  # ======================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            cd /var/www/textisur
            
            # Pull latest code
            git pull origin main
            
            # Install dependencies
            npm ci --production
            
            # Run migrations
            node run-migration-manual.js
            
            # Build application
            npm run build
            
            # Reload PM2
            pm2 reload ecosystem.config.js --env production
            
            # Save PM2 state
            pm2 save
            
            echo "Deployment completed successfully!"

  # ======================================
  # Job 3: Smoke Tests
  # ======================================
  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Newman (Postman CLI)
        run: npm install -g newman

      - name: Wait for deployment
        run: sleep 30

      - name: Run API tests
        run: |
          newman run tests/api-tests.postman_collection.json \
            --env-var "baseUrl=${{ secrets.PRODUCTION_URL }}" \
            --reporters cli,json \
            --reporter-json-export newman-results.json
        continue-on-error: true

      - name: Health Check
        run: |
          HEALTH_URL="${{ secrets.PRODUCTION_URL }}/api/health"
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
          
          if [ $RESPONSE -eq 200 ]; then
            echo "‚úÖ Health check passed"
            exit 0
          else
            echo "‚ùå Health check failed with status: $RESPONSE"
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: newman-results.json
          retention-days: 7

  # ======================================
  # Job 4: Notify on Failure
  # ======================================
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy, smoke-tests]
    if: failure()
    
    steps:
      - name: Send Slack notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'üö® Production deployment failed!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()
